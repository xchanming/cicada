/**
 * @package framework
 */
import OverrideComponentRegisterPlugin from './index';
import path from 'path';

describe('build/vite-plugins/override-component-register', () => {
    it('should be a function with 1 optional argument', () => {
        expect(typeof OverrideComponentRegisterPlugin).toBe('function');

        // check that the function takes 1 argument
        expect(OverrideComponentRegisterPlugin.length).toBe(1);
    });

    it('should return an object with a name, configResolved and transform property', () => {
        const plugin = OverrideComponentRegisterPlugin({
            root: 'root',
            pluginEntryFile: 'plugin',
        });

        // Identify plugin by name
        expect(plugin).toHaveProperty('name');
        expect(plugin.name).toBe('shopware-vite-plugin-override-component');

        // Check if the plugin has all methods
        expect(plugin).toHaveProperty('configResolved');
        expect(plugin).toHaveProperty('transform');
    });

    it('should return null if transform is called without calling configResolved', () => {
        const plugin = OverrideComponentRegisterPlugin({
            root: 'root',
            pluginEntryFile: 'plugin',
        });

        const result = plugin.transform('code', 'id');

        expect(result).toBe(null);
    });

    it('should transform entry file correctly', () => {
        const plugin = OverrideComponentRegisterPlugin({
            root: path.resolve(__dirname, './_fixtures'),
            pluginEntryFile: 'plugin',
        });

        // Call configResolved to find all override files
        plugin.configResolved();

        const mainEntryCode = `
            import { createApp } from 'vue';
            import App from './App.vue';
            import './assets/style.scss';

            createApp(App).mount('#app');
        `;

        const result = plugin.transform(mainEntryCode, 'plugin');

        // Check if the code was transformed correctly
        expect(result).toHaveProperty('code');
        expect(result.code).toContain('/* Start: auto generated by Shopware */');
        expect(result.code).toContain(
            "import _spec from './build/vite-plugins/override-component-register/_fixtures/spec.override.vue';",
        );
        expect(result.code).toContain('Shopware.Component.registerOverrideComponent(_spec);');
        expect(result.code).toContain('/* End: auto generated by Shopware */');
    });
});
